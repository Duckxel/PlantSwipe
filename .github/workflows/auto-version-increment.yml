name: Auto Version Increment

on:
  push:
    branches:
      - main
      - master
    # Only trigger when there's a merge commit (PRs merged)

jobs:
  version-increment:
    runs-on: ubuntu-latest
    # Only run on merge commits (commits with 2+ parents)
    if: github.event.head_commit.message != '' && (startsWith(github.event.head_commit.message, 'Merge pull request') || startsWith(github.event.head_commit.message, 'Merge branch'))
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate lines added and determine version bump
        id: version_calc
        run: |
          # Get the merge commit SHA
          MERGE_COMMIT="${{ github.sha }}"
          
          echo "Merge commit: $MERGE_COMMIT"
          
          # Get parent commits of the merge
          PARENTS=$(git log -1 --format="%P" $MERGE_COMMIT)
          PARENT_COUNT=$(echo $PARENTS | wc -w)
          
          echo "Parents: $PARENTS"
          echo "Parent count: $PARENT_COUNT"
          
          # For merge commits, we want to calculate lines added from the merged branch
          if [ "$PARENT_COUNT" -ge 2 ]; then
            # First parent is the base branch (main), second is the merged branch
            BASE_PARENT=$(echo $PARENTS | cut -d' ' -f1)
            MERGED_PARENT=$(echo $PARENTS | cut -d' ' -f2)
            
            echo "Base parent: $BASE_PARENT"
            echo "Merged parent: $MERGED_PARENT"
            
            # Calculate lines added in the merge (only additions, not deletions)
            LINES_ADDED=$(git diff --numstat $BASE_PARENT $MERGE_COMMIT | awk '{ added += $1 } END { print added }')
            
            # Handle empty result
            if [ -z "$LINES_ADDED" ] || [ "$LINES_ADDED" = "" ]; then
              LINES_ADDED=0
            fi
          else
            # Not a true merge commit, just a regular commit
            LINES_ADDED=$(git diff --numstat HEAD~1 HEAD | awk '{ added += $1 } END { print added }')
            
            if [ -z "$LINES_ADDED" ] || [ "$LINES_ADDED" = "" ]; then
              LINES_ADDED=0
            fi
          fi
          
          echo "Lines added: $LINES_ADDED"
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          
          # Determine bump type based on lines added
          # Thresholds (adjustable):
          # - 5000+ lines: MAJOR bump (1.0.0)
          # - 500+ lines: MINOR bump (0.1.0)
          # - Otherwise: PATCH bump (0.0.1)
          
          MAJOR_THRESHOLD=5000
          MINOR_THRESHOLD=500
          
          if [ "$LINES_ADDED" -ge "$MAJOR_THRESHOLD" ]; then
            BUMP_TYPE="major"
          elif [ "$LINES_ADDED" -ge "$MINOR_THRESHOLD" ]; then
            BUMP_TYPE="minor"
          else
            BUMP_TYPE="patch"
          fi
          
          echo "Bump type: $BUMP_TYPE"
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Get current version from package.json
        id: current_version
        run: |
          CURRENT_VERSION=$(node -p "require('./plant-swipe/package.json').version")
          echo "Current version: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Get highest version from all branches
        id: highest_version
        run: |
          # Fetch all remote branches
          git fetch --all
          
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          HIGHEST_VERSION="$CURRENT_VERSION"
          
          # Function to compare versions (returns 1 if v1 > v2, 0 if equal, -1 if v1 < v2)
          compare_versions() {
            local v1="$1"
            local v2="$2"
            
            # Parse versions into components
            IFS='.' read -r v1_major v1_minor v1_patch <<< "$v1"
            IFS='.' read -r v2_major v2_minor v2_patch <<< "$v2"
            
            # Remove any non-numeric characters
            v1_major=${v1_major//[!0-9]/}
            v1_minor=${v1_minor//[!0-9]/}
            v1_patch=${v1_patch//[!0-9]/}
            v2_major=${v2_major//[!0-9]/}
            v2_minor=${v2_minor//[!0-9]/}
            v2_patch=${v2_patch//[!0-9]/}
            
            # Set defaults for empty values
            v1_major=${v1_major:-0}
            v1_minor=${v1_minor:-0}
            v1_patch=${v1_patch:-0}
            v2_major=${v2_major:-0}
            v2_minor=${v2_minor:-0}
            v2_patch=${v2_patch:-0}
            
            if [ "$v1_major" -gt "$v2_major" ]; then
              echo "1"
            elif [ "$v1_major" -lt "$v2_major" ]; then
              echo "-1"
            elif [ "$v1_minor" -gt "$v2_minor" ]; then
              echo "1"
            elif [ "$v1_minor" -lt "$v2_minor" ]; then
              echo "-1"
            elif [ "$v1_patch" -gt "$v2_patch" ]; then
              echo "1"
            elif [ "$v1_patch" -lt "$v2_patch" ]; then
              echo "-1"
            else
              echo "0"
            fi
          }
          
          # Check main/master branch versions
          for branch in $(git branch -r | grep -E 'origin/(main|master)$' | sed 's/origin\///'); do
            if git show "origin/$branch:plant-swipe/package.json" &>/dev/null; then
              BRANCH_VERSION=$(git show "origin/$branch:plant-swipe/package.json" | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version" 2>/dev/null || echo "0.0.0")
              
              if [ -n "$BRANCH_VERSION" ] && [ "$BRANCH_VERSION" != "null" ]; then
                COMPARISON=$(compare_versions "$BRANCH_VERSION" "$HIGHEST_VERSION")
                if [ "$COMPARISON" = "1" ]; then
                  HIGHEST_VERSION="$BRANCH_VERSION"
                  echo "Found higher version $BRANCH_VERSION in branch $branch"
                fi
              fi
            fi
          done
          
          echo "Highest version found: $HIGHEST_VERSION"
          echo "version=$HIGHEST_VERSION" >> $GITHUB_OUTPUT
          
          # Check if versions are the same (skip bump if both branches had same version)
          COMPARISON=$(compare_versions "$CURRENT_VERSION" "$HIGHEST_VERSION")
          if [ "$COMPARISON" = "0" ]; then
            echo "same_version=true" >> $GITHUB_OUTPUT
          else
            echo "same_version=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate new version
        id: new_version
        run: |
          HIGHEST_VERSION="${{ steps.highest_version.outputs.version }}"
          BUMP_TYPE="${{ steps.version_calc.outputs.bump_type }}"
          SAME_VERSION="${{ steps.highest_version.outputs.same_version }}"
          
          echo "Starting from highest version: $HIGHEST_VERSION"
          echo "Bump type: $BUMP_TYPE"
          
          # Parse version
          IFS='.' read -r major minor patch <<< "$HIGHEST_VERSION"
          
          # Remove any non-numeric characters and set defaults
          major=${major//[!0-9]/}
          minor=${minor//[!0-9]/}
          patch=${patch//[!0-9]/}
          major=${major:-0}
          minor=${minor:-0}
          patch=${patch:-0}
          
          # Apply version bump
          case "$BUMP_TYPE" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          NEW_VERSION="${major}.${minor}.${patch}"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          
          echo "Updating version from $CURRENT_VERSION to $NEW_VERSION"
          
          # Update version in package.json using Node.js for safe JSON handling
          node -e "
            const fs = require('fs');
            const packagePath = './plant-swipe/package.json';
            const pkg = JSON.parse(fs.readFileSync(packagePath, 'utf8'));
            pkg.version = '$NEW_VERSION';
            fs.writeFileSync(packagePath, JSON.stringify(pkg, null, 2) + '\n');
            console.log('Updated package.json version to', pkg.version);
          "

      - name: Commit and push version update
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          LINES_ADDED="${{ steps.version_calc.outputs.lines_added }}"
          BUMP_TYPE="${{ steps.version_calc.outputs.bump_type }}"
          
          # Check if there are changes to commit
          if git diff --quiet plant-swipe/package.json; then
            echo "No version changes to commit"
            exit 0
          fi
          
          git add plant-swipe/package.json
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]
          
          Automatic version increment triggered by merge.
          - Lines added: $LINES_ADDED
          - Bump type: $BUMP_TYPE"
          
          git push origin HEAD

      - name: Summary
        run: |
          echo "## Version Increment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Version | ${{ steps.current_version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| New Version | ${{ steps.new_version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Added | ${{ steps.version_calc.outputs.lines_added }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump Type | ${{ steps.version_calc.outputs.bump_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Bump Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "- **Major** (x.0.0): 5,000+ lines added" >> $GITHUB_STEP_SUMMARY
          echo "- **Minor** (0.x.0): 500+ lines added" >> $GITHUB_STEP_SUMMARY
          echo "- **Patch** (0.0.x): Less than 500 lines added" >> $GITHUB_STEP_SUMMARY
