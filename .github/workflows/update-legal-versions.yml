name: Update Legal Document Versions

on:
  push:
    branches:
      - main
    paths:
      - 'plant-swipe/src/content/terms-of-service.html'
      - 'plant-swipe/src/content/privacy-policy.html'

jobs:
  update-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check which files changed
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            plant-swipe/src/content/terms-of-service.html
            plant-swipe/src/content/privacy-policy.html

      - name: Determine which documents changed
        id: docs-changed
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          TERMS_CHANGED=false
          PRIVACY_CHANGED=false
          
          # Check each changed file
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Changed file: $file"
            if [[ "$file" == "plant-swipe/src/content/terms-of-service.html" ]]; then
              TERMS_CHANGED=true
            fi
            if [[ "$file" == "plant-swipe/src/content/privacy-policy.html" ]]; then
              PRIVACY_CHANGED=true
            fi
          done
          
          echo "terms_changed=$TERMS_CHANGED" >> $GITHUB_OUTPUT
          echo "privacy_changed=$PRIVACY_CHANGED" >> $GITHUB_OUTPUT
          echo "Terms changed: $TERMS_CHANGED"
          echo "Privacy changed: $PRIVACY_CHANGED"

      - name: Update Terms version
        if: steps.docs-changed.outputs.terms_changed == 'true'
        run: |
          VERSION_FILE="plant-swipe/src/content/terms-version.json"
          HTML_FILE="plant-swipe/src/content/terms-of-service.html"
          
          # Calculate lines changed in the HTML file
          LINES_CHANGED=$(git diff HEAD~1 HEAD --numstat -- "$HTML_FILE" 2>/dev/null | awk '{ print $1 + $2 }')
          LINES_CHANGED=${LINES_CHANGED:-0}
          echo "Lines changed in Terms: $LINES_CHANGED"
          
          # Read current version
          CURRENT_VERSION=$(node -e "console.log(require('./$VERSION_FILE').version)")
          echo "Current Terms version: $CURRENT_VERSION"
          
          # Parse version components
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          
          # Determine version bump based on lines changed
          # Thresholds for legal documents:
          # - Major (1.0.0): >= 500 lines (significant rewrite)
          # - Minor (0.1.0): >= 50 lines (substantial changes)
          # - Patch (0.0.1): < 50 lines (small fixes/typos)
          if [ "$LINES_CHANGED" -ge 500 ]; then
            BUMP_TYPE="major"
            NEW_VERSION="$((MAJOR + 1)).0.0"
          elif [ "$LINES_CHANGED" -ge 50 ]; then
            BUMP_TYPE="minor"
            NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
          else
            BUMP_TYPE="patch"
            NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
          fi
          
          echo "Bump type: $BUMP_TYPE"
          echo "New Terms version: $NEW_VERSION"
          
          # Get current date in ISO format
          CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          
          # Update the JSON file
          node -e "
            const fs = require('fs');
            const data = require('./$VERSION_FILE');
            
            // Update version and date
            data.version = '$NEW_VERSION';
            data.lastUpdated = '$CURRENT_DATE';
            
            // Add to changelog
            data.changelog.unshift({
              version: '$NEW_VERSION',
              date: '$CURRENT_DATE',
              summary: 'Terms of Service updated ($BUMP_TYPE - $LINES_CHANGED lines changed)'
            });
            
            // Keep only last 20 changelog entries
            data.changelog = data.changelog.slice(0, 20);
            
            fs.writeFileSync('$VERSION_FILE', JSON.stringify(data, null, 2) + '\n');
            console.log('Updated $VERSION_FILE');
          "

      - name: Update Privacy version
        if: steps.docs-changed.outputs.privacy_changed == 'true'
        run: |
          VERSION_FILE="plant-swipe/src/content/privacy-version.json"
          HTML_FILE="plant-swipe/src/content/privacy-policy.html"
          
          # Calculate lines changed in the HTML file
          LINES_CHANGED=$(git diff HEAD~1 HEAD --numstat -- "$HTML_FILE" 2>/dev/null | awk '{ print $1 + $2 }')
          LINES_CHANGED=${LINES_CHANGED:-0}
          echo "Lines changed in Privacy: $LINES_CHANGED"
          
          # Read current version
          CURRENT_VERSION=$(node -e "console.log(require('./$VERSION_FILE').version)")
          echo "Current Privacy version: $CURRENT_VERSION"
          
          # Parse version components
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          
          # Determine version bump based on lines changed
          # Thresholds for legal documents:
          # - Major (1.0.0): >= 500 lines (significant rewrite)
          # - Minor (0.1.0): >= 50 lines (substantial changes)
          # - Patch (0.0.1): < 50 lines (small fixes/typos)
          if [ "$LINES_CHANGED" -ge 500 ]; then
            BUMP_TYPE="major"
            NEW_VERSION="$((MAJOR + 1)).0.0"
          elif [ "$LINES_CHANGED" -ge 50 ]; then
            BUMP_TYPE="minor"
            NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
          else
            BUMP_TYPE="patch"
            NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
          fi
          
          echo "Bump type: $BUMP_TYPE"
          echo "New Privacy version: $NEW_VERSION"
          
          # Get current date in ISO format
          CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          
          # Update the JSON file
          node -e "
            const fs = require('fs');
            const data = require('./$VERSION_FILE');
            
            // Update version and date
            data.version = '$NEW_VERSION';
            data.lastUpdated = '$CURRENT_DATE';
            
            // Add to changelog
            data.changelog.unshift({
              version: '$NEW_VERSION',
              date: '$CURRENT_DATE',
              summary: 'Privacy Policy updated ($BUMP_TYPE - $LINES_CHANGED lines changed)'
            });
            
            // Keep only last 20 changelog entries
            data.changelog = data.changelog.slice(0, 20);
            
            fs.writeFileSync('$VERSION_FILE', JSON.stringify(data, null, 2) + '\n');
            console.log('Updated $VERSION_FILE');
          "

      - name: Commit version updates
        if: steps.docs-changed.outputs.terms_changed == 'true' || steps.docs-changed.outputs.privacy_changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add only version files
          git add plant-swipe/src/content/terms-version.json plant-swipe/src/content/privacy-version.json
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No version changes to commit"
          else
            COMMIT_MSG="chore: auto-update legal document versions [skip ci]"
            
            if [ "${{ steps.docs-changed.outputs.terms_changed }}" == "true" ]; then
              COMMIT_MSG="$COMMIT_MSG\n\n- Terms of Service version incremented"
            fi
            
            if [ "${{ steps.docs-changed.outputs.privacy_changed }}" == "true" ]; then
              COMMIT_MSG="$COMMIT_MSG\n\n- Privacy Policy version incremented"
            fi
            
            git commit -m "$(echo -e "$COMMIT_MSG")"
            git push
            echo "Version files updated and pushed"
          fi
