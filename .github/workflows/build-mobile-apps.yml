name: Build Mobile Apps

on:
  # Trigger after version bump commits on main branch
  push:
    branches:
      - main
    paths:
      - 'plant-swipe/package.json'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      skip_ios:
        description: 'Skip iOS build'
        required: false
        default: 'false'
        type: boolean
      skip_android:
        description: 'Skip Android build'
        required: false
        default: 'false'
        type: boolean
      publish_ios:
        description: 'Publish iOS to TestFlight'
        required: false
        default: 'false'
        type: boolean
      publish_android:
        description: 'Publish Android to Play Store (internal track)'
        required: false
        default: 'false'
        type: boolean
      android_track:
        description: 'Android release track (internal/alpha/beta/production)'
        required: false
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      create_release:
        description: 'Create GitHub release'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write

env:
  NODE_VERSION: '20'
  BUN_VERSION: '1.1.0'
  RUBY_VERSION: '3.2'

jobs:
  # Get version from package.json
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
      should_build: ${{ steps.check.outputs.should_build }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if this is a version bump commit
        id: check
        run: |
          # Get the last commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          # Check if it's a version bump commit or manual trigger
          if [[ "$COMMIT_MSG" == *"chore: bump version"* ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "This is a version bump commit or manual trigger, proceeding with build"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "Not a version bump commit, skipping build"
          fi
      
      - name: Get version from package.json
        id: version
        if: steps.check.outputs.should_build == 'true'
        run: |
          VERSION=$(node -p "require('./plant-swipe/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Calculate Android versionCode: MAJOR * 1000000 + MINOR * 1000 + PATCH
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          VERSION_CODE=$((MAJOR * 1000000 + MINOR * 1000 + PATCH))
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          
          echo "Version: $VERSION"
          echo "Version Code: $VERSION_CODE"

  # Build web app (shared between iOS and Android)
  build-web:
    needs: get-version
    if: needs.get-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        working-directory: plant-swipe
        run: bun install
      
      - name: Build web app
        working-directory: plant-swipe
        run: bun run build
        env:
          SKIP_SITEMAP_GENERATION: '1'
          VITE_APP_VERSION: ${{ needs.get-version.outputs.version }}
      
      - name: Upload web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: plant-swipe/dist
          retention-days: 1

  # Build and optionally publish iOS app
  build-ios:
    needs: [get-version, build-web]
    if: |
      needs.get-version.outputs.should_build == 'true' && 
      (github.event.inputs.skip_ios != 'true' || github.event_name != 'workflow_dispatch')
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: plant-swipe/ios
      
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: plant-swipe/dist
      
      - name: Install dependencies
        working-directory: plant-swipe
        run: bun install
      
      - name: Add iOS platform if not exists
        working-directory: plant-swipe
        run: |
          if [ ! -d "ios" ]; then
            npx cap add ios
          fi
      
      - name: Sync Capacitor
        working-directory: plant-swipe
        run: npx cap sync ios
      
      - name: Install CocoaPods
        working-directory: plant-swipe/ios/App
        run: pod install --repo-update
      
      - name: Install Fastlane
        working-directory: plant-swipe/ios
        run: bundle install
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app
      
      # Build unsigned IPA (when not publishing)
      - name: Build unsigned IPA
        if: github.event.inputs.publish_ios != 'true'
        working-directory: plant-swipe/ios/App
        run: |
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -destination generic/platform=iOS \
            -archivePath build/App.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            MARKETING_VERSION=${{ needs.get-version.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.get-version.outputs.version_code }}
          
          mkdir -p build/Payload
          cp -r build/App.xcarchive/Products/Applications/App.app build/Payload/
          cd build
          zip -r ../Aphylia-${{ needs.get-version.outputs.version }}-unsigned.ipa Payload
      
      # Build and publish signed IPA using Fastlane (when publishing)
      - name: Build and upload to TestFlight
        if: github.event.inputs.publish_ios == 'true'
        working-directory: plant-swipe/ios
        run: bundle exec fastlane ci_beta
        env:
          APP_IDENTIFIER: ${{ secrets.IOS_APP_IDENTIFIER || 'app.aphylia.mobile' }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTH: ${{ secrets.MATCH_GIT_BASIC_AUTH }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_KEYCHAIN_NAME: fastlane_keychain
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD || 'fastlane_ci' }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          CHANGELOG: "Automated build from CI - version ${{ needs.get-version.outputs.version }}"
      
      - name: Rename unsigned IPA artifact
        if: github.event.inputs.publish_ios != 'true'
        working-directory: plant-swipe/ios/App
        run: |
          mkdir -p ../build
          if [ -f "Aphylia-${{ needs.get-version.outputs.version }}-unsigned.ipa" ]; then
            mv "Aphylia-${{ needs.get-version.outputs.version }}-unsigned.ipa" ../build/
          fi
      
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: |
            plant-swipe/ios/App/Aphylia-*.ipa
            plant-swipe/ios/build/*.ipa
          retention-days: 30

  # Build and optionally publish Android app
  build-android:
    needs: [get-version, build-web]
    if: |
      needs.get-version.outputs.should_build == 'true' && 
      (github.event.inputs.skip_android != 'true' || github.event_name != 'workflow_dispatch')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: plant-swipe/android
      
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: plant-swipe/dist
      
      - name: Install dependencies
        working-directory: plant-swipe
        run: bun install
      
      - name: Add Android platform if not exists
        working-directory: plant-swipe
        run: |
          if [ ! -d "android" ]; then
            npx cap add android
          fi
      
      - name: Sync Capacitor
        working-directory: plant-swipe
        run: npx cap sync android
      
      - name: Install Fastlane
        working-directory: plant-swipe/android
        run: bundle install
      
      # Decode and setup signing key (only when publishing)
      - name: Decode Android signing key
        if: github.event.inputs.publish_android == 'true'
        working-directory: plant-swipe/android
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release-key.jks
          echo "${{ secrets.GOOGLE_PLAY_JSON_KEY_BASE64 }}" | base64 --decode > google-play-key.json
      
      # Build unsigned APK and AAB (when not publishing)
      - name: Build unsigned artifacts
        if: github.event.inputs.publish_android != 'true'
        working-directory: plant-swipe/android
        run: |
          bundle exec fastlane build_debug
          bundle exec fastlane build_release
      
      # Build signed and publish to Play Store (when publishing)
      - name: Build and upload to Play Store
        if: github.event.inputs.publish_android == 'true'
        working-directory: plant-swipe/android
        run: |
          TRACK="${{ github.event.inputs.android_track || 'internal' }}"
          case "$TRACK" in
            internal) bundle exec fastlane ci_internal ;;
            alpha) bundle exec fastlane alpha ;;
            beta) bundle exec fastlane ci_beta ;;
            production) bundle exec fastlane ci_release rollout:0.1 ;;
          esac
        env:
          ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME || 'app.aphylia.mobile' }}
          GOOGLE_PLAY_JSON_KEY_PATH: google-play-key.json
          ANDROID_KEYSTORE_PATH: release-key.jks
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      
      - name: Collect build artifacts
        working-directory: plant-swipe/android
        run: |
          mkdir -p artifacts
          find . -name "*.apk" -exec cp {} artifacts/ \; 2>/dev/null || true
          find . -name "*.aab" -exec cp {} artifacts/ \; 2>/dev/null || true
          find build -name "*.apk" -exec cp {} artifacts/ \; 2>/dev/null || true
          find build -name "*.aab" -exec cp {} artifacts/ \; 2>/dev/null || true
          ls -la artifacts/ || echo "No artifacts found"
      
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-app
          path: |
            plant-swipe/android/artifacts/*.apk
            plant-swipe/android/artifacts/*.aab
            plant-swipe/android/build/*.apk
            plant-swipe/android/build/*.aab
            plant-swipe/android/app/build/outputs/apk/**/*.apk
            plant-swipe/android/app/build/outputs/bundle/**/*.aab
          retention-days: 30

  # Create GitHub Release
  create-release:
    needs: [get-version, build-ios, build-android]
    if: |
      always() && 
      needs.get-version.outputs.should_build == 'true' &&
      (github.event.inputs.create_release != 'false' || github.event_name != 'workflow_dispatch') &&
      (needs.build-ios.result == 'success' || needs.build-android.result == 'success')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Collect release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.ipa" \) -exec cp {} release-files/ \; 2>/dev/null || true
          ls -la release-files/ || echo "No release files found"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.get-version.outputs.version }}
          name: Aphylia v${{ needs.get-version.outputs.version }}
          body: |
            ## Aphylia v${{ needs.get-version.outputs.version }}
            
            ### Mobile App Downloads
            
            #### iOS
            - **IPA**: For development/enterprise deployment
            - To install, use Apple Configurator, Xcode, or sign with your developer certificate
            ${{ github.event.inputs.publish_ios == 'true' && '- **TestFlight**: Build has been uploaded to TestFlight for beta testing' || '' }}
            
            #### Android
            - **Debug APK**: Install directly on Android devices (developer mode required)
            - **Release AAB**: For Google Play distribution
            ${{ github.event.inputs.publish_android == 'true' && format('- **Play Store**: Build has been uploaded to {0} track', github.event.inputs.android_track || 'internal') || '' }}
            
            ### Web App
            The web app at [aphylia.app](https://aphylia.app) has been updated to this version.
            
            ### Changelog
            See the [commit history](https://github.com/${{ github.repository }}/commits/main) for changes.
            
            ---
            
            **Build Info**
            - Version: ${{ needs.get-version.outputs.version }}
            - Version Code: ${{ needs.get-version.outputs.version_code }}
            - Build: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
          draft: false
          prerelease: false
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary job
  summary:
    needs: [get-version, build-web, build-ios, build-android, create-release]
    if: always() && needs.get-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Build Summary
        run: |
          echo "## Mobile App Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.get-version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Code | ${{ needs.get-version.outputs.version_code }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web Build | ${{ needs.build-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Build | ${{ needs.build-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event.inputs.publish_ios }}" == "true" ]]; then
            echo "### iOS Publishing" >> $GITHUB_STEP_SUMMARY
            echo "- Uploaded to TestFlight" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ github.event.inputs.publish_android }}" == "true" ]]; then
            echo "### Android Publishing" >> $GITHUB_STEP_SUMMARY
            echo "- Uploaded to Play Store (${{ github.event.inputs.android_track || 'internal' }} track)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Release Created" >> $GITHUB_STEP_SUMMARY
            echo "Download the mobile apps from the [Releases page](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.get-version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          fi
