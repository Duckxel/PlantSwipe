/**
 * Aphylia Chat Bubble
 * 
 * A floating action button that opens the AI chat panel.
 * Positioned in the bottom-right corner of the screen.
 * On mobile, positioned above the navigation bar.
 */

import React from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { cn } from '@/lib/utils'

interface AphyliaChatBubbleProps {
  isOpen: boolean
  onClick: () => void
  hasUnreadMessage?: boolean
  className?: string
}

export const AphyliaChatBubble: React.FC<AphyliaChatBubbleProps> = ({
  isOpen,
  onClick,
  hasUnreadMessage = false,
  className
}) => {
  return (
    <motion.button
      onClick={onClick}
      className={cn(
        // Position: above mobile nav on mobile, normal position on desktop
        'fixed z-50',
        // Mobile: above the nav bar (which is ~60px + safe area)
        'bottom-[calc(70px+env(safe-area-inset-bottom))] right-4',
        // Desktop: normal bottom-right position
        'md:bottom-6 md:right-6',
        // Transparent button - just the SVG, nothing else
        'bg-transparent border-none p-0',
        'cursor-pointer',
        'focus:outline-none',
        className
      )}
      initial={{ scale: 0, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      exit={{ scale: 0, opacity: 0 }}
      whileHover={{ scale: 1.05 }}
      whileTap={{ scale: 0.95 }}
      aria-label={isOpen ? 'Close Aphylia chat' : 'Open Aphylia chat'}
    >
      <AnimatePresence mode="wait">
        {isOpen ? (
          <motion.div
            key="close"
            initial={{ rotate: -90, opacity: 0 }}
            animate={{ rotate: 0, opacity: 1 }}
            exit={{ rotate: 90, opacity: 0 }}
            transition={{ duration: 0.2 }}
          >
            <svg
              className="w-12 h-12 md:w-14 md:h-14"
              viewBox="0 0 2000 2000"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              style={{ fillRule: 'evenodd', clipRule: 'evenodd', strokeLinejoin: 'round', strokeMiterlimit: 2 }}
            >
              <g transform="matrix(2.56815,0,0,2.56815,-314.634821,-288.247854)">
                <path d="M236.336,454.813C210.483,396.545 214.805,336.801 223.044,301.789C227.565,282.577 234.044,269.765 237.557,265.371C249.475,250.466 264.53,247.32 280.684,251.55C287.225,253.263 294.135,256.637 300.771,260.906C305.089,244.113 310.872,224.236 317.167,209.776C326.628,188.044 337.937,178.005 349.84,174.128C358.312,171.368 368.122,171.161 380.102,175.095C390.174,178.402 403.179,185.446 420.589,196.094C423.948,198.148 427.17,200.195 430.092,202.094C440.988,186.298 456.765,162.911 470.75,147.724C479.089,138.669 487.345,132.1 494.119,128.821C500.336,125.811 506.225,124.751 511.437,124.946C523.8,125.41 539.184,133.538 553.321,148.481C566.487,162.397 583.719,186.784 594.008,201.903C606.496,193.809 624.139,182.972 636.57,177.803C653.203,170.888 668.249,170.849 677.757,175.223C688.238,180.045 699.333,192.779 707.213,211.129C713.578,225.952 718.723,244.916 722.666,261.265C739.924,250.254 753.559,248.705 763.357,250.878C773.571,253.144 782.301,259.128 789.015,269.751C794.259,278.047 798.436,290.629 801.667,306.621C803.686,316.619 815.094,373.715 795.703,433.974C793.149,441.912 789.595,450.004 787.372,454.794C833.594,551.927 832.636,703.963 684.062,788.566C660.566,801.945 614.929,825.232 539.002,829.779C538.894,829.785 538.785,829.791 538.677,829.796C477.118,832.674 439.214,821.698 417.159,814.467L408.351,811.58C393.3,822.067 353.882,851.891 334.226,865.621C324.999,872.067 318.096,875.629 316.166,876.251C305.896,879.564 281.475,880.574 266.327,866.248C257.007,857.433 248.677,842.467 253.685,815.833C254.88,809.478 266.581,748.71 269.651,729.728C261.24,720.855 233.906,689.252 218.582,638.759C193.225,555.205 228.37,472.463 236.336,454.813Z" style={{ fill: 'white' }}/>
              </g>
              <g transform="matrix(2.56815,0,0,2.56815,-314.634821,-288.247854)">
                <path d="M537.516,804.962C446.973,809.194 411.63,781.297 402.644,785.812C394.944,789.681 314.802,850.568 308.533,852.59C299.945,855.361 271.312,856.627 278.119,820.428C279.56,812.766 295.212,729.53 295.247,724.493C295.327,712.944 263.282,700.439 242.372,631.539C218.621,553.277 254.043,475.858 259.663,463.574C262.823,456.668 264.54,456.371 261.303,449.596C224.608,372.788 248.518,291.474 256.975,280.898C274.713,258.714 310.84,304.875 315.605,303.795C318.132,303.222 325.63,252.622 339.962,219.7C353.711,188.119 365.341,191.448 407.618,217.304C433.007,232.831 434.249,237.962 439.05,232.11C450.759,217.841 491.808,149.09 510.506,149.791C538.484,150.839 580.301,235.295 588.521,234.799C593.477,234.499 649.058,189.388 667.366,197.81C691.359,208.848 704.038,299.811 707.527,303.475C709.878,305.944 712.158,300.218 729.174,287.075C761.23,262.316 770.393,277.37 777.297,311.544C779.118,320.557 789.517,372.035 772.036,426.359C765.705,446.035 758.229,452.193 761.875,459.308C806.632,546.643 809.131,688.738 671.76,766.961C650.022,779.339 607.762,800.755 537.516,804.962Z" style={{ fill: 'rgb(21,21,21)' }}/>
                <path d="M494.491,548.926L500.539,549.134C683.696,551.691 727.757,489.504 734.619,491.144C736.839,491.675 750.357,522.115 753.646,560.486C767.259,719.312 577.444,818.76 410.353,750.869C393.715,744.109 386.023,755.243 360.165,774.021C320.409,802.891 321,803.766 318.464,804.383C313.366,805.625 316.887,793.117 317.203,791.439C318.227,785.997 329.99,723.483 330.004,723.407C333.811,701.779 317.996,700.145 299.817,673.286C292.895,663.06 251.976,605.174 278.447,517.483C286.755,489.96 288.592,489.084 290.542,490.432C291.868,491.349 344.796,546.323 494.491,548.926Z" style={{ fill: 'rgb(253,253,253)' }}/>
                <path d="M550.503,516.948C548.5,516.987 546.497,517.026 544.494,517.066C502.642,518.243 501.418,516.825 497.71,510.378C485.466,489.09 476.319,435.649 513.933,370.753C565.725,281.394 647.099,236.714 652.516,238.456C663.66,242.04 708.24,394.795 629.976,486.925C608.392,512.332 588.767,514.3 584.526,514.725C573.743,515.806 553.227,516.814 550.503,516.948Z" style={{ fill: 'rgb(253,253,253)' }}/>
                <path d="M349.058,362.532C345.857,287.731 365.687,239.714 371.463,238.355C375.447,237.418 433.111,267.072 472.896,324.222C488.521,346.667 487.226,348.836 482.091,356.207C470.252,373.198 463.422,394.882 462.301,398.441C435.682,482.946 467.917,507.774 456.334,513.056C452.608,514.755 431.314,511.268 428.46,510.67C405.865,505.937 378.593,474.804 363.961,436.33C350.111,399.912 349.188,364.236 349.058,362.532Z" style={{ fill: 'rgb(253,253,254)' }}/>
                <path d="M499.608,300.419C473.059,267.763 469.865,269.735 467.456,260.511C464.013,247.329 507.695,195.77 508.709,194.713C512.03,191.248 514.682,193.589 523.986,206.139C553.799,246.354 561.531,258.671 550.356,269.344C529.943,288.841 531.24,289.987 516.44,306.446C508.672,315.086 506.388,309.875 499.608,300.419Z" style={{ fill: 'rgb(253,253,254)' }}/>
                <path d="M745.861,345.486C747.52,384.79 743.621,448.939 683.258,482.069C682.809,482.315 674.902,486.655 676.885,482.639C683.191,469.868 697.32,450.856 706.91,398.569C713.169,364.439 703.576,358.053 732.861,330.91C738.779,325.425 742.383,322.738 744.147,330.587C744.894,333.914 745.761,344.29 745.861,345.486Z" style={{ fill: 'rgb(253,253,253)' }}/>
                <path d="M314.113,379.536C325.04,467.306 351.017,479.102 345.783,483.866C344.108,485.391 268.259,453.763 277.905,340.539C277.995,339.487 277.642,315.075 294.036,333.928C310.943,353.372 311.787,353.922 314.113,379.536Z" style={{ fill: 'rgb(253,253,254)' }}/>
              </g>
            </svg>
          </motion.div>
        ) : (
          <motion.div
            key="open"
            initial={{ scale: 0.8, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0.8, opacity: 0 }}
            transition={{ duration: 0.2 }}
          >
            <svg
              className="w-12 h-12 md:w-14 md:h-14"
              viewBox="0 0 2000 2000"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              style={{ fillRule: 'evenodd', clipRule: 'evenodd', strokeLinejoin: 'round', strokeMiterlimit: 2 }}
            >
              <g transform="matrix(2.56815,0,0,2.56815,-314.634821,-288.247854)">
                <path d="M236.336,454.813C210.483,396.545 214.805,336.801 223.044,301.789C227.565,282.577 234.044,269.765 237.557,265.371C249.475,250.466 264.53,247.32 280.684,251.55C287.225,253.263 294.135,256.637 300.771,260.906C305.089,244.113 310.872,224.236 317.167,209.776C326.628,188.044 337.937,178.005 349.84,174.128C358.312,171.368 368.122,171.161 380.102,175.095C390.174,178.402 403.179,185.446 420.589,196.094C423.948,198.148 427.17,200.195 430.092,202.094C440.988,186.298 456.765,162.911 470.75,147.724C479.089,138.669 487.345,132.1 494.119,128.821C500.336,125.811 506.225,124.751 511.437,124.946C523.8,125.41 539.184,133.538 553.321,148.481C566.487,162.397 583.719,186.784 594.008,201.903C606.496,193.809 624.139,182.972 636.57,177.803C653.203,170.888 668.249,170.849 677.757,175.223C688.238,180.045 699.333,192.779 707.213,211.129C713.578,225.952 718.723,244.916 722.666,261.265C739.924,250.254 753.559,248.705 763.357,250.878C773.571,253.144 782.301,259.128 789.015,269.751C794.259,278.047 798.436,290.629 801.667,306.621C803.686,316.619 815.094,373.715 795.703,433.974C793.149,441.912 789.595,450.004 787.372,454.794C833.594,551.927 832.636,703.963 684.062,788.566C660.566,801.945 614.929,825.232 539.002,829.779C538.894,829.785 538.785,829.791 538.677,829.796C477.118,832.674 439.214,821.698 417.159,814.467L408.351,811.58C393.3,822.067 353.882,851.891 334.226,865.621C324.999,872.067 318.096,875.629 316.166,876.251C305.896,879.564 281.475,880.574 266.327,866.248C257.007,857.433 248.677,842.467 253.685,815.833C254.88,809.478 266.581,748.71 269.651,729.728C261.24,720.855 233.906,689.252 218.582,638.759C193.225,555.205 228.37,472.463 236.336,454.813Z" style={{ fill: 'white' }}/>
              </g>
              <g transform="matrix(2.56815,0,0,2.56815,-314.634821,-288.247854)">
                <path d="M537.516,804.962C446.973,809.194 411.63,781.297 402.644,785.812C394.944,789.681 314.802,850.568 308.533,852.59C299.945,855.361 271.312,856.627 278.119,820.428C279.56,812.766 295.212,729.53 295.247,724.493C295.327,712.944 263.282,700.439 242.372,631.539C218.621,553.277 254.043,475.858 259.663,463.574C262.823,456.668 264.54,456.371 261.303,449.596C224.608,372.788 248.518,291.474 256.975,280.898C274.713,258.714 310.84,304.875 315.605,303.795C318.132,303.222 325.63,252.622 339.962,219.7C353.711,188.119 365.341,191.448 407.618,217.304C433.007,232.831 434.249,237.962 439.05,232.11C450.759,217.841 491.808,149.09 510.506,149.791C538.484,150.839 580.301,235.295 588.521,234.799C593.477,234.499 649.058,189.388 667.366,197.81C691.359,208.848 704.038,299.811 707.527,303.475C709.878,305.944 712.158,300.218 729.174,287.075C761.23,262.316 770.393,277.37 777.297,311.544C779.118,320.557 789.517,372.035 772.036,426.359C765.705,446.035 758.229,452.193 761.875,459.308C806.632,546.643 809.131,688.738 671.76,766.961C650.022,779.339 607.762,800.755 537.516,804.962Z" style={{ fill: 'rgb(21,21,21)' }}/>
                <path d="M494.491,548.926L500.539,549.134C683.696,551.691 727.757,489.504 734.619,491.144C736.839,491.675 750.357,522.115 753.646,560.486C767.259,719.312 577.444,818.76 410.353,750.869C393.715,744.109 386.023,755.243 360.165,774.021C320.409,802.891 321,803.766 318.464,804.383C313.366,805.625 316.887,793.117 317.203,791.439C318.227,785.997 329.99,723.483 330.004,723.407C333.811,701.779 317.996,700.145 299.817,673.286C292.895,663.06 251.976,605.174 278.447,517.483C286.755,489.96 288.592,489.084 290.542,490.432C291.868,491.349 344.796,546.323 494.491,548.926Z" style={{ fill: 'rgb(253,253,253)' }}/>
                <path d="M550.503,516.948C548.5,516.987 546.497,517.026 544.494,517.066C502.642,518.243 501.418,516.825 497.71,510.378C485.466,489.09 476.319,435.649 513.933,370.753C565.725,281.394 647.099,236.714 652.516,238.456C663.66,242.04 708.24,394.795 629.976,486.925C608.392,512.332 588.767,514.3 584.526,514.725C573.743,515.806 553.227,516.814 550.503,516.948Z" style={{ fill: 'rgb(253,253,253)' }}/>
                <path d="M349.058,362.532C345.857,287.731 365.687,239.714 371.463,238.355C375.447,237.418 433.111,267.072 472.896,324.222C488.521,346.667 487.226,348.836 482.091,356.207C470.252,373.198 463.422,394.882 462.301,398.441C435.682,482.946 467.917,507.774 456.334,513.056C452.608,514.755 431.314,511.268 428.46,510.67C405.865,505.937 378.593,474.804 363.961,436.33C350.111,399.912 349.188,364.236 349.058,362.532Z" style={{ fill: 'rgb(253,253,254)' }}/>
                <path d="M499.608,300.419C473.059,267.763 469.865,269.735 467.456,260.511C464.013,247.329 507.695,195.77 508.709,194.713C512.03,191.248 514.682,193.589 523.986,206.139C553.799,246.354 561.531,258.671 550.356,269.344C529.943,288.841 531.24,289.987 516.44,306.446C508.672,315.086 506.388,309.875 499.608,300.419Z" style={{ fill: 'rgb(253,253,254)' }}/>
                <path d="M745.861,345.486C747.52,384.79 743.621,448.939 683.258,482.069C682.809,482.315 674.902,486.655 676.885,482.639C683.191,469.868 697.32,450.856 706.91,398.569C713.169,364.439 703.576,358.053 732.861,330.91C738.779,325.425 742.383,322.738 744.147,330.587C744.894,333.914 745.761,344.29 745.861,345.486Z" style={{ fill: 'rgb(253,253,253)' }}/>
                <path d="M314.113,379.536C325.04,467.306 351.017,479.102 345.783,483.866C344.108,485.391 268.259,453.763 277.905,340.539C277.995,339.487 277.642,315.075 294.036,333.928C310.943,353.372 311.787,353.922 314.113,379.536Z" style={{ fill: 'rgb(253,253,254)' }}/>
              </g>
            </svg>
          </motion.div>
        )}
      </AnimatePresence>
      
      {/* Unread indicator */}
      {hasUnreadMessage && !isOpen && (
        <motion.div
          className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white"
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ type: 'spring', stiffness: 500, damping: 25 }}
        />
      )}
    </motion.button>
  )
}

export default AphyliaChatBubble
