// Collapsible Node Styles for TipTap Editor

.collapsible-node {
  // Ensure the node is properly displayed as a block
  display: block !important;
  position: relative;
  // Ensure proper visibility and stacking
  z-index: 1;
  // Ensure it's not clipped
  overflow: visible;

  // Header styling
  .collapsible-header {
    display: flex;
    align-items: center;
    user-select: none;
    position: relative;
    z-index: 2;
    
    // Prevent text selection during drag
    &:active {
      cursor: grabbing;
    }
  }

  // Drag handle
  .collapsible-drag-handle {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    
    &:hover {
      opacity: 1;
    }
  }

  // Content wrapper with smooth transitions
  .collapsible-content-wrapper {
    will-change: max-height, opacity;
    position: relative;
    z-index: 1;
  }

  // Inner content - ensure TipTap editor styles apply
  .collapsible-inner-content {
    // Ensure content is editable and visible
    min-height: 1.5em;
    // Critical: Allow editing within the content area
    outline: none;
    
    // Reset some styles to ensure nested content looks correct
    > *:first-child {
      margin-top: 0;
    }

    > *:last-child {
      margin-bottom: 0;
    }

    // Ensure nested paragraphs have proper spacing
    p {
      margin: 0.75em 0;
      
      &:first-child {
        margin-top: 0;
      }
      
      &:last-child {
        margin-bottom: 0;
      }
    }

    // Ensure headings in nested content look good
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1em;
      margin-bottom: 0.5em;
      font-weight: bold;
      
      &:first-child {
        margin-top: 0;
      }
    }

    h1 { font-size: 2em; }
    h2 { font-size: 1.5em; }
    h3 { font-size: 1.25em; }
    h4 { font-size: 1.1em; }
    h5 { font-size: 1em; }
    h6 { font-size: 0.9em; }

    // Lists inside collapsible - bullet and ordered
    ul, ol {
      margin: 0.75em 0;
      padding-left: 1.5em;
      
      li {
        margin: 0.25em 0;
        
        p {
          margin: 0;
        }
      }
    }

    ul {
      list-style-type: disc;
      
      ul {
        list-style-type: circle;
        
        ul {
          list-style-type: square;
        }
      }
    }

    ol {
      list-style-type: decimal;
    }

    // Task lists inside collapsible
    ul[data-type="taskList"] {
      list-style: none;
      padding-left: 0;
      
      li {
        display: flex;
        align-items: flex-start;
        gap: 0.5em;
        
        > label {
          flex-shrink: 0;
          margin-top: 0.25em;
        }
        
        > div {
          flex: 1;
          min-width: 0;
        }
      }
    }

    // Blockquotes inside collapsible
    blockquote {
      margin: 1em 0;
      padding-left: 1em;
      border-left: 3px solid currentColor;
      opacity: 0.8;
    }

    // Code blocks inside collapsible
    pre {
      margin: 1em 0;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
      background-color: rgba(0, 0, 0, 0.05);
      
      code {
        background: none;
        padding: 0;
        font-size: 0.9em;
      }
    }

    // Inline code
    code {
      background-color: rgba(0, 0, 0, 0.08);
      padding: 0.125em 0.25em;
      border-radius: 4px;
      font-size: 0.9em;
    }

    // Horizontal rules
    hr {
      margin: 1.5em 0;
      border: none;
      border-top: 2px solid rgba(0, 0, 0, 0.1);
    }

    // Images inside collapsible
    img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    // Nested collapsibles
    .collapsible-node {
      margin: 1em 0;
    }

    // Text formatting
    strong, b {
      font-weight: bold;
    }

    em, i {
      font-style: italic;
    }

    u {
      text-decoration: underline;
    }

    s, strike {
      text-decoration: line-through;
    }

    // Links
    a {
      color: #059669;
      text-decoration: underline;
      
      &:hover {
        color: #047857;
      }
    }

    // Placeholder for empty content
    &:empty::before,
    > p:only-child:empty::before {
      content: "Type your content here...";
      color: #9ca3af;
      font-style: italic;
      pointer-events: none;
    }
  }

  // Selected state
  &[data-selected="true"],
  &:focus-within {
    outline: none;
  }
}

// Ensure proper rendering in the editor
.ProseMirror {
  // Ensure collapsible nodes are visible and properly layered
  .collapsible-node {
    // Cursor positioning
    &::before {
      content: none;
    }

    // Gap cursor support
    &.ProseMirror-selectednode {
      outline: none;
    }
    
    // Ensure visibility within the editor
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  // Ensure drag handle works
  [data-drag-handle] {
    cursor: grab;
    
    &:active {
      cursor: grabbing;
    }
  }
  
  // Ensure NodeViewWrapper renders correctly
  [data-type="collapsible"] {
    display: block !important;
    position: relative;
  }
}

// Animation for expand/collapse
@keyframes collapsible-expand {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes collapsible-collapse {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-8px);
  }
}

.collapsible-content-wrapper {
  &[data-state="open"] {
    animation: collapsible-expand 0.2s ease-out;
  }
  
  &[data-state="closed"] {
    animation: collapsible-collapse 0.2s ease-out;
  }
}

// Dark mode adjustments
.dark {
  .collapsible-node {
    .collapsible-inner-content {
      blockquote {
        opacity: 0.9;
      }
    }
  }
}

// Print styles
@media print {
  .collapsible-node {
    // Always show content when printing
    .collapsible-content-wrapper {
      max-height: none !important;
      opacity: 1 !important;
    }
    
    // Hide interactive elements
    .collapsible-drag-handle,
    button[aria-label="Section settings"] {
      display: none;
    }
  }
}
