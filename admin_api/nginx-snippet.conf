# Health check endpoint
location = /admin/health {
    proxy_pass http://127.0.0.1:5001/health;
    proxy_set_header X-Real-IP $remote_addr;
}

location = /admin/restart-app {
    limit_except POST { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/restart-app;
    proxy_set_header X-Real-IP $remote_addr;
}

location = /admin/reload-nginx {
    limit_except POST { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/reload-nginx;
    proxy_set_header X-Real-IP $remote_addr;
}

location = /admin/reboot {
    limit_except POST { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/reboot;
    proxy_set_header X-Real-IP $remote_addr;
}

# Branch list (GET)
location = /admin/branches {
    limit_except GET { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/branches;
    proxy_set_header X-Real-IP $remote_addr;
}

# Pull & Build (fire-and-forget; GET/POST)
location = /admin/pull-code {
    proxy_pass http://127.0.0.1:5001/admin/pull-code;
    proxy_set_header X-Real-IP $remote_addr;
}

# Pull & Build streaming logs (SSE)
location = /admin/pull-code/stream {
    limit_except GET { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/pull-code/stream;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_buffering off;
    proxy_read_timeout 1h;
}

# Sync database schema (GET/POST)
location = /admin/sync-schema {
    proxy_pass http://127.0.0.1:5001/admin/sync-schema;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 5m;
}

# Deploy Supabase Edge Functions (GET/POST)
location = /admin/deploy-edge-functions {
    proxy_pass http://127.0.0.1:5001/admin/deploy-edge-functions;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 15m;
}

# Run setup script (POST, streaming)
location = /admin/run-setup {
    limit_except POST { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/run-setup;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_buffering off;
    proxy_read_timeout 30m;
}

# Clear memory cache (POST)
location = /admin/clear-memory {
    limit_except POST { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/clear-memory;
    proxy_set_header X-Real-IP $remote_addr;
}

# Restart server services (POST, streaming)
location = /admin/restart-server {
    limit_except POST { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/restart-server;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_buffering off;
    proxy_read_timeout 5m;
}

# Simple git pull (GET/POST)
location = /admin/git-pull {
    proxy_pass http://127.0.0.1:5001/admin/git-pull;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 5m;
}

# Git pull with streaming output (SSE)
location = /admin/git-pull/stream {
    limit_except GET { deny all; }
    proxy_pass http://127.0.0.1:5001/admin/git-pull/stream;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_buffering off;
    proxy_read_timeout 5m;
}
